<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC webcam</title>
    <style>
    button {
        padding: 8px 16px;
    }

    video {
        width: 100%;
    }

    .option {
        margin-bottom: 8px;
    }

    #media {
        max-width: 1280px;
    }
    </style>
</head>
<body>

<button id="start" onclick="start()">Start</button>
<button id="stop" style="display: none" onclick="stop()">Stop</button>
<!-- Recording controls removed per request -->

<div class="option">
    <input type="file" id="upload_audio" accept="audio/*" />
    <button class="btn btn-primary" id="btn_upload_audio">Upload Audio</button>
    <span id="upload_hint"></span>
</div>
<div class="option">
    <input type="file" id="upload_source" accept="image/*,video/*" />
    <button class="btn btn-primary" id="btn_upload_source">Upload Source (Image/Video)</button>
    <span id="upload_source_hint"></span>
</div>
<input type="hidden" id="sessionid" value="0">

<div id="media">
    <h2>Media</h2>

    <audio id="audio" autoplay="true"></audio>
    <video id="video" style="width:600px;" autoplay="true" playsinline="true"></video>
</div>

<script src="client.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
</body>
<script type="text/javascript" charset="utf-8">

	$(document).ready(function() {
	  // var host = window.location.hostname
	  // var ws = new WebSocket("ws://"+host+":8000/humanecho");
	  // //document.getElementsByTagName("video")[0].setAttribute("src", aa["video"]);
	  // ws.onopen = function() {
		// console.log('Connected');
	  // };
	  // ws.onmessage = function(e) {
		// console.log('Received: ' + e.data);
		// data = e
		// var vid = JSON.parse(data.data); 
		// console.log(typeof(vid),vid)
		// //document.getElementsByTagName("video")[0].setAttribute("src", vid["video"]);
		
	  // };
	  // ws.onclose = function(e) {
		// console.log('Closed');
	  // };

      // removed echo-form; no TTS trigger from text input

      // Source upload handlers (image/video)
      let selectedSource = null;
      $('#upload_source').on('change', function(e) {
          selectedSource = e.target.files && e.target.files.length ? e.target.files[0] : null;
          $('#upload_source_hint').text(selectedSource ? ('Selected: ' + selectedSource.name) : '');
      });
      $('#btn_upload_source').on('click', function() {
          const sid = parseInt(document.getElementById('sessionid').value);
          if (!sid) {
              alert('Please click Start to establish a session first.');
              return;
          }
          if (!selectedSource) {
              alert('Please choose an image or video first.');
              return;
          }
          const fd = new FormData();
          fd.append('sessionid', String(sid));
          fd.append('file', selectedSource);
          $('#btn_upload_source').prop('disabled', true);
          $('#upload_source_hint').text('Uploading source...');
          fetch('/humansource', {
              method: 'POST',
              body: fd,
          }).then(function(resp) {
              if (!resp.ok) throw new Error('Upload failed');
              return resp.json();
          }).then(function(data) {
              console.log('Source upload ok:', data);
              $('#upload_source_hint').text('Source set: ' + (data && data.path ? data.path : 'OK'));
          }).catch(function(err) {
              console.error('Upload source error:', err);
              $('#upload_source_hint').text('Upload failed');
          }).finally(function(){
              $('#btn_upload_source').prop('disabled', false);
          });
      });

      // Audio upload handlers
      let selectedFile = null;
      $('#upload_audio').on('change', function(e) {
          selectedFile = e.target.files && e.target.files.length ? e.target.files[0] : null;
          $('#upload_hint').text(selectedFile ? ('Selected: ' + selectedFile.name) : '');
      });

      $('#btn_upload_audio').on('click', function() {
          const sid = parseInt(document.getElementById('sessionid').value);
          if (!sid) {
              alert('Please click Start to establish a session first.');
              return;
          }
          if (!selectedFile) {
              alert('Please choose an audio file first.');
              return;
          }
          const fd = new FormData();
          fd.append('sessionid', String(sid));
          fd.append('file', selectedFile);
          $('#btn_upload_audio').prop('disabled', true);
          $('#upload_hint').text('Uploading...');
          fetch('/humanaudio', {
              method: 'POST',
              body: fd,
          }).then(function(resp) {
              if (!resp.ok) throw new Error('Upload failed');
              return resp.json();
          }).then(function(data) {
              console.log('Upload ok:', data);
              $('#upload_hint').text('Uploaded. The avatar should respond shortly.');
          }).catch(function(err) {
              console.error('Upload error:', err);
              $('#upload_hint').text('Upload failed');
          }).finally(function(){
              $('#btn_upload_audio').prop('disabled', false);
          });
      });

    // $('#btn_download').click(function() {
    //     // 下载视频文件
    //     console.log('Downloading video...');
    //     fetch('/record_lasted.mp4', {
    //         method: 'GET'
    //     }).then(function(response) {
    //         if (response.ok) {
    //             return response.blob();
    //         } else {
    //             throw new Error('Failed to download the video.');
    //         }
    //     }).then(function(blob) {
    //         // 创建一个 Blob 对象
    //         const url = window.URL.createObjectURL(blob);
    //         // 创建一个隐藏的可下载链接
    //         const a = document.createElement('a');
    //         a.style.display = 'none';
    //         a.href = url;
    //         a.download = 'record_lasted.mp4';
    //         document.body.appendChild(a);
    //         // 触发下载
    //         a.click();
    //         // 清理
    //         window.URL.revokeObjectURL(url);
    //         document.body.removeChild(a);
    //         console.log('Video downloaded successfully.');
    //     }).catch(function(error) {
    //         console.error('Error:', error);
    //     });
    // });

	});

  
</script>
</html>